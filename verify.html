<!DOCTYPE html>
<html>
<head>
  <title>Email Verified</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="firebase/firebase.js"></script>
</head>
<body>
  <h2>Verifying your email...</h2>
  <script>
    const params = new URLSearchParams(window.location.search);
    const mode = params.get('mode');
    const oobCode = params.get('oobCode');

    if (mode === 'verifyEmail' && oobCode) {
      firebase.auth().applyActionCode(oobCode)
        .then(() => {
          alert("Email verified successfully!");

          // Get the current user and update Firestore
          firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
              const uid = user.uid;

              // Update verified status in Firestore
              await firebase.firestore().collection("pending_connections").doc(uid).update({
                "person1.verified": true
              });

              // Redirect to person-1.html to add partner details
              window.location.href = `person-1.html?uid=${uid}`;
            }
          });
        })
        .catch((error) => {
          console.error("Verification failed:", error);
          alert("Invalid or expired link.");
        });
    } else {
      alert("Invalid link.");
    }
  </script>
</body>
</html>
