<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accept Invitation | LoveSpace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="firebase/firebase.js"></script>
</head>
<body class="flex items-center justify-center min-h-screen bg-pink-100">

  <div class="bg-white p-6 rounded-lg shadow-md max-w-sm w-full text-center">
    <h2 class="text-xl font-bold text-pink-700 mb-3">You're Invited ðŸ’Œ</h2>
    <p id="inviter" class="text-sm text-gray-600 mb-4">Loading invite details...</p>

    <div id="partner-form" class="hidden">
      <input type="text" id="partnerName" placeholder="Your Name" class="w-full p-2 mb-3 border rounded" />
      <button onclick="acceptInvite()" class="bg-pink-600 text-white w-full p-2 rounded hover:bg-pink-700">
        Accept Invitation
      </button>
    </div>

    <p id="status" class="text-sm text-gray-600 mt-4"></p>
  </div>

  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();

    const uid = new URLSearchParams(window.location.search).get("uid");

    let partnerEmail = null;

    async function fetchInvitation() {
      try {
        const doc = await db.collection("pending_connections").doc(uid).get();

        if (!doc.exists) {
          document.getElementById("inviter").innerText = "Invalid or expired invitation.";
          return;
        }

        const data = doc.data();
        const p1 = data.person1;
        const p2 = data.person2;

        partnerEmail = p2.email;

        document.getElementById("inviter").innerHTML = `
          <strong>${p1.name}</strong> (${p1.email}) invited you to join LoveSpace. <br/>
          Your email: <strong>${p2.email}</strong>
        `;

        document.getElementById("partner-form").classList.remove("hidden");

      } catch (err) {
        document.getElementById("inviter").innerText = "Error loading invite.";
      }
    }

    async function acceptInvite() {
      const name = document.getElementById("partnerName").value.trim();
      const status = document.getElementById("status");

      if (!name) {
        status.innerText = "Please enter your name.";
        return;
      }

      try {
        // Update Firestore
        await db.collection("pending_connections").doc(uid).update({
          "person2.name": name,
          "person2.verified": true,
          status: "connected",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Move to shared dashboard (replace with actual dashboard file)
        window.location.href = `dashboard.html?uid=${uid}`;

      } catch (error) {
        status.innerText = "Error accepting invitation: " + error.message;
      }
    }

    fetchInvitation();
  </script>
</body>
</html>
